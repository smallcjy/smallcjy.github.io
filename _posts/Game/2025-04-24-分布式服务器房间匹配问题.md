---
title: 分布式服务器房间匹配问题
date: 2025-04-20 16:30:31
tags: [游戏后台]
---

之前接触的业务的玩家加入房间都是自带房间id，不走匹配这个逻辑。但是最近遇到没有房间id，需要在一段匹配时间内的匹配房间，需要实现分布式的匹配房间逻辑，故写此文章记录开发历程。

## 全局匹配节点
客户端加入房间请求需要携带roomid，但是没有roomid需要前往匹配节点进行匹配获取roomid。匹配节点通常与我们熟知的大厅服务器放在一起。服务端单独开个匹配房间的接口，客户端检测到玩家点击开始游戏后，先调用这个接口向服务端进行房间匹配得到房间id。客户端再拿着房间id向房间进行连接。

## 匹配逻辑的实现
匹配的需求有这样几个：
- 支持不同房间类型分开匹配。在游戏中体现为不同的段位或者玩家画像进行分开匹配；
- 支持匹配时间，匹配时间内选择相同类型房间的玩家会被匹配到一起
- 支持匹配人数上限。房间人数存在上限，所以匹配期间应该限制匹配人数的上限

### 实现方案 Redis实现方案

对于需求一：使用redis kv 存储即可实现。key值为能够标识不同房间类型的唯一标识，表示正在匹配中的房间；value为匹配中的房间的房间id，用于请求返回。

对于需求二：给kv设置过期时间即可表示匹配时间

对于需求三：使用redis inrc自增计数即可，在匹配时加以判断

对于匹配错误的情况，就是新建一个全局唯一的房间id缓存进redis

**redis作为中间件，这套方案再分布式环境下同样适用。**